<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finanzas IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fade-in { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.2s ease-out forwards; }
    </style>
    
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-[#f2f2f7]">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, 
            signInAnonymously, 
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            orderBy, 
            onSnapshot, 
            serverTimestamp
        } from 'firebase/firestore';
        import { 
            Send, Mic, Download, MoreVertical, StopCircle, 
            Share, LogOut, User 
        } from 'lucide-react';

        // ---------------------------------------------------------
        // âš ï¸ CONFIGURACIÃ“N FIREBASE Y GEMINI
        // ---------------------------------------------------------
        
        const firebaseConfig = {
            apiKey: "AIzaSyDGpXkfs-CQXnq6CeOGl6AEHIUXqbDvF8U",
            authDomain: "finanzaschat-54721.firebaseapp.com",
            projectId: "finanzaschat-54721",
            storageBucket: "finanzaschat-54721.firebasestorage.app",
            messagingSenderId: "673675834438",
            appId: "1:673675834438:web:53984c62a30e3afe484647",
            measurementId: "G-W5P04LQSXH"
        };
        
        // Clave de Gemini
        const GEMINI_API_KEY = "AIzaSyBsrxA4VfJT8UflwzrOeKyuDLM6ET6vmbI"; 

        const appId = 'default-app-id'; // Identificador para la DB
        // ---------------------------------------------------------

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Estilos iOS
        const IOS_SAFE_AREA_TOP = "env(safe-area-inset-top)";
        const IOS_SAFE_AREA_BOTTOM = "env(safe-area-inset-bottom)";

        // --- Componente de Login ---
        const LoginScreen = ({ onLoginSuccess }) => {
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [isRegistering, setIsRegistering] = useState(false);
            const [error, setError] = useState("");
            const [loading, setLoading] = useState(false);

            const handleAuth = async (e) => {
                e.preventDefault();
                setError("");
                setLoading(true);
                try {
                    if (isRegistering) {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    console.error(err);
                    let msg = "Error de autenticaciÃ³n";
                    if (err.code === 'auth/invalid-email') msg = "El correo no es vÃ¡lido.";
                    if (err.code === 'auth/user-not-found' || err.code === 'auth/invalid-credential') msg = "Credenciales incorrectas.";
                    if (err.code === 'auth/wrong-password') msg = "ContraseÃ±a incorrecta.";
                    if (err.code === 'auth/email-already-in-use') msg = "Este correo ya estÃ¡ registrado.";
                    if (err.code === 'auth/weak-password') msg = "La contraseÃ±a debe tener al menos 6 caracteres.";
                    setError(msg);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="flex flex-col h-screen bg-[#f2f2f7] justify-center px-6">
                    <div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm mx-auto">
                        <div className="flex justify-center mb-6">
                            <div className="w-16 h-16 bg-[#007AFF] rounded-2xl flex items-center justify-center text-white text-3xl shadow-lg">
                                ðŸ’¸
                            </div>
                        </div>
                        <h2 className="text-2xl font-bold text-center mb-1 text-gray-800">
                            {isRegistering ? "Crear Cuenta" : "Bienvenido"}
                        </h2>
                        <p className="text-center text-gray-500 mb-8 text-sm">
                            {isRegistering ? "Registra tus gastos en la nube" : "Inicia sesiÃ³n para sincronizar"}
                        </p>

                        <form onSubmit={handleAuth} className="space-y-4">
                            <div>
                                <label className="block text-xs font-semibold text-gray-500 mb-1 ml-1 uppercase">Correo</label>
                                <input 
                                    type="email" 
                                    required
                                    className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 outline-none focus:border-[#007AFF] focus:ring-2 focus:ring-[#007AFF]/20 transition text-gray-700"
                                    placeholder="ejemplo@correo.com"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-semibold text-gray-500 mb-1 ml-1 uppercase">ContraseÃ±a</label>
                                <input 
                                    type="password" 
                                    required
                                    className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 outline-none focus:border-[#007AFF] focus:ring-2 focus:ring-[#007AFF]/20 transition text-gray-700"
                                    placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                />
                            </div>

                            {error && <div className="text-red-500 text-sm text-center bg-red-50 p-2 rounded-lg">{error}</div>}

                            <button 
                                type="submit" 
                                disabled={loading}
                                className="w-full bg-[#007AFF] hover:bg-[#0063ce] text-white font-semibold py-3.5 rounded-xl shadow-lg shadow-blue-500/30 transition transform active:scale-95 disabled:opacity-70 flex justify-center items-center"
                            >
                                {loading ? (
                                    <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                ) : (
                                    isRegistering ? "Registrarse" : "Ingresar"
                                )}
                            </button>
                        </form>

                        <div className="mt-6 text-center">
                            <button 
                                onClick={() => { setIsRegistering(!isRegistering); setError(""); }}
                                className="text-[#007AFF] text-sm font-medium hover:underline"
                            >
                                {isRegistering ? "Â¿Ya tienes cuenta? Ingresa aquÃ­" : "Â¿Nuevo usuario? Crea una cuenta"}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Componente Principal App ---
        function App() {
            const [user, setUser] = useState(null);
            const [messages, setMessages] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [inputText, setInputText] = useState("");
            const [isRecording, setIsRecording] = useState(false);
            const [loadingAI, setLoadingAI] = useState(false);
            const [showInstallHelp, setShowInstallHelp] = useState(false);
            const [showMenu, setShowMenu] = useState(false);
            
            const messagesEndRef = useRef(null);
            const recognitionRef = useRef(null);

            // Auth listener
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                });
                return () => unsubscribe();
            }, []);

            // Detectar iOS
            useEffect(() => {
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
                if (isIOS && !isStandalone) setTimeout(() => setShowInstallHelp(true), 3000);
            }, []);

            // Cargar Transacciones
            useEffect(() => {
                if (!user) return;
                const q = query(
                    collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'), 
                    orderBy('date', 'desc')
                );
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setTransactions(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return () => unsubscribe();
            }, [user]);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages, loadingAI]);

            useEffect(() => {
                if (user && messages.length === 0) {
                    setMessages([{
                        id: 'welcome',
                        role: 'system',
                        text: 'Â¡Hola! Soy tu contador personal. Tus datos ahora estÃ¡n sincronizados.',
                        timestamp: new Date()
                    }]);
                }
            }, [user]);

            // LÃ³gica IA Corregida
            const processWithGemini = async (text) => {
                setLoadingAI(true);
                const apiKey = GEMINI_API_KEY; 

                // 1. Preparar datos
                const recentTransactions = transactions.slice(0, 30).map(t => {
                    let dateStr = "Hoy";
                    if (t.date && t.date.seconds) {
                        const d = new Date(t.date.seconds * 1000);
                        dateStr = d.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit' });
                    }
                    return `- [${dateStr}] ${t.type}: $${t.amount} | Cat: ${t.category} | Sub: ${t.subcategory || '-'} | Detalle: ${t.detail || '-'}`;
                }).join("\n");

                // 2. Instrucciones (System Prompt)
                const systemPrompt = `
                    ActÃºa como una app de finanzas (Modo iOS).
                    
                    TUS HERRAMIENTAS DE DATOS (Lo que el usuario ya guardÃ³):
                    ${recentTransactions}

                    INSTRUCCIONES:
                    1. SI ES UN NUEVO REGISTRO (Gasto/Ingreso):
                       Responde JSON: { "action": "add", "type": "gasto"|"ingreso", "amount": number, "category": string, "subcategory": string, "detail": string, "response_text": string }
                    
                    2. SI ES UNA CONSULTA (Â¿QuÃ© gastÃ©? Â¿Lista de super?):
                       Responde JSON: { "action": "query", "response_text": string }
                       
                       IMPORTANTE: Cuando listes gastos, USA ESTE FORMATO EXACTO por cada lÃ­nea:
                       "ðŸ“… DD/MM | ðŸ’° $Valor | ðŸ“‚ Categoria > Subcategoria | ðŸ“ Detalle"
                       
                       Si el detalle estÃ¡ vacÃ­o, no lo pongas.
                `;

                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: text }] }],
                                systemInstruction: { parts: [{ text: systemPrompt }] },
                                generationConfig: { responseMimeType: "application/json" }
                            })
                        }
                    );

                    if (!response.ok) {
                         const errorData = await response.json();
                         throw new Error(`Error API: ${errorData.error?.message || response.statusText}`);
                    }

                    const data = await response.json();
                    if (!data.candidates) throw new Error("Sin respuesta de IA");

                    const result = JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text);
                    
                    if (result.action === "add") {
                        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'), {
                            ...result,
                            date: serverTimestamp()
                        });
                        addMessage("system", result.response_text || "Anotado.");
                    } else {
                        // Si pregunta balance general, calculamos nosotros
                        if (text.toLowerCase().includes('balance') || text.toLowerCase().includes('queda') || text.toLowerCase().includes('total')) {
                             const ing = transactions.filter(t => t.type === 'ingreso').reduce((a,b)=>a+b.amount,0);
                             const gas = transactions.filter(t => t.type === 'gasto').reduce((a,b)=>a+b.amount,0);
                             addMessage("system", `ðŸ“Š Balance Global:\n\nðŸŸ¢ Ingresos: $${ing}\nðŸ”´ Gastos: $${gas}\n\nðŸ’° Total: $${ing - gas}`);
                        } else {
                             addMessage("system", result.response_text);
                        }
                    }

                } catch (e) {
                    console.error(e);
                    addMessage("system", `Error: ${e.message}. Intenta de nuevo.`);
                } finally {
                    setLoadingAI(false);
                }
            };

            const addMessage = (role, text) => {
                setMessages(p => [...p, { id: Date.now(), role, text, timestamp: new Date() }]);
            };

            const handleSend = () => {
                if (!inputText.trim()) return;
                addMessage("user", inputText);
                processWithGemini(inputText);
                setInputText("");
            };

            const handleLogout = () => {
                signOut(auth);
                setMessages([]);
                setShowMenu(false);
            };

            const startRecording = () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) { alert("Usa Safari o Chrome."); return; }
                const recognition = new SpeechRecognition();
                recognition.lang = 'es-AR';
                recognition.onstart = () => setIsRecording(true);
                recognition.onresult = (e) => setInputText(e.results[0][0].transcript);
                recognition.onend = () => setIsRecording(false);
                recognitionRef.current = recognition;
                recognition.start();
            };
            const stopRecording = () => recognitionRef.current?.stop();

            if (!user) {
                return <LoginScreen />;
            }

            return (
                <div className="flex flex-col h-screen font-sans text-gray-900 overflow-hidden">
                    {/* Header */}
                    <div className="bg-white/90 backdrop-blur-md border-b border-gray-200 px-4 flex items-center justify-between sticky top-0 z-20"
                         style={{ paddingTop: `max(1rem, ${IOS_SAFE_AREA_TOP})`, paddingBottom: '0.8rem' }}>
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-[#007AFF]">
                                <User size={16} />
                            </div>
                            <div className="flex flex-col">
                                <span className="font-semibold text-sm leading-none">Finanzas</span>
                                <span className="text-[10px] text-gray-500">{user.email?.split('@')[0]}</span>
                            </div>
                        </div>
                        
                        <div className="relative">
                            <button onClick={() => setShowMenu(!showMenu)} className="p-2 text-[#007AFF]">
                                <MoreVertical size={22} />
                            </button>
                            {showMenu && (
                                <div className="absolute right-0 top-full mt-2 bg-white rounded-xl shadow-xl border border-gray-100 w-40 overflow-hidden py-1 animate-fade-in z-50">
                                    <button onClick={() => alert("FunciÃ³n Exportar (PrÃ³ximamente)")} className="w-full text-left px-4 py-3 text-sm hover:bg-gray-50 flex items-center gap-2 text-gray-700">
                                        <Download size={16} /> Exportar
                                    </button>
                                    <div className="border-t border-gray-100 my-1"></div>
                                    <button onClick={handleLogout} className="w-full text-left px-4 py-3 text-sm hover:bg-red-50 text-red-600 flex items-center gap-2">
                                        <LogOut size={16} /> Cerrar SesiÃ³n
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Chat */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-[#e5e5ea]" onClick={() => setShowMenu(false)}>
                        {messages.map(msg => (
                            <div key={msg.id} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] p-3 rounded-2xl text-[16px] shadow-sm whitespace-pre-wrap ${
                                    msg.role === 'user' 
                                    ? 'bg-[#007AFF] text-white rounded-br-none' 
                                    : 'bg-white text-black rounded-bl-none'
                                }`}>
                                    {msg.text}
                                </div>
                            </div>
                        ))}
                        {loadingAI && <div className="text-gray-400 text-xs text-center">Sincronizando...</div>}
                        <div ref={messagesEndRef} />
                    </div>

                    {/* Input */}
                    <div className="bg-[#f9f9f9] border-t border-gray-200 p-2 flex items-end gap-2"
                         style={{ paddingBottom: `max(0.5rem, ${IOS_SAFE_AREA_BOTTOM})` }}>
                        <button className="p-2 text-[#007AFF]"> <span className="text-2xl">+</span> </button>
                        <div className="flex-1 bg-white border border-gray-300 rounded-full px-4 py-2 mb-1 flex items-center">
                            <input 
                                value={inputText}
                                onChange={(e) => setInputText(e.target.value)}
                                placeholder="Nuevo gasto..."
                                className="flex-1 bg-transparent outline-none text-[16px]"
                                onKeyDown={(e) => e.key === 'Enter' && handleSend()}
                            />
                        </div>
                        {inputText ? (
                            <button onClick={handleSend} className="p-3 bg-[#007AFF] rounded-full text-white mb-1 shadow-md transform active:scale-90 transition">
                                <Send size={18} />
                            </button>
                        ) : (
                            <button 
                                onTouchStart={startRecording} 
                                onTouchEnd={stopRecording}
                                onMouseDown={startRecording}
                                onMouseUp={stopRecording}
                                className={`p-3 rounded-full text-white mb-1 transition-all shadow-md ${isRecording ? 'bg-red-500 scale-110' : 'bg-[#007AFF]'}`}
                            >
                                {isRecording ? <StopCircle size={18} /> : <Mic size={18} />}
                            </button>
                        )}
                    </div>

                    {/* Ayuda Install */}
                    {showInstallHelp && (
                        <div className="absolute inset-x-0 bottom-0 bg-white/95 backdrop-blur shadow-2xl rounded-t-2xl p-6 z-50 border-t border-gray-200 pb-10">
                            <div className="flex justify-between items-start mb-4">
                                <h3 className="font-bold text-lg">Instalar App</h3>
                                <button onClick={() => setShowInstallHelp(false)} className="text-gray-400">âœ•</button>
                            </div>
                            <p className="text-sm text-gray-600 mb-4">Para pantalla completa y mejor experiencia:</p>
                            <ol className="text-sm space-y-3">
                                <li className="flex items-center gap-3">
                                    <span className="bg-gray-100 w-6 h-6 rounded-full flex items-center justify-center font-bold text-xs">1</span>
                                    <span>Toca <Share size={14} className="inline mx-1"/> <strong>Compartir</strong> abajo.</span>
                                </li>
                                <li className="flex items-center gap-3">
                                    <span className="bg-gray-100 w-6 h-6 rounded-full flex items-center justify-center font-bold text-xs">2</span>
                                    <span>Elige <strong>"Agregar a inicio"</strong>.</span>
                                </li>
                            </ol>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
